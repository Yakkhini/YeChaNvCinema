# nftables, clash, dns, 透明代理那些事

在本文中，你可以看到以下内容：

* 什么是透明代理？为什么要使用透明代理？
* nftables的使用，linux网络机制和代理机制
* dns污染，DoH、DoT是什么
* clash的完全配置解析
* ~~爆破鬼才吉格斯的符文选择及出装思路~~

2021年秋冬交际，我身体里的电竞之魂突然觉醒，迷上了英雄联盟这个奇妙的游戏。在linux上，其实很多游戏的优化都做到不错（至少可玩）的程度了，而英雄联盟除了国服以外的大多其他国家的服务器都被正常适配。

具体如何安装运行，你可以在[lutris的英雄联盟板块](https://lutris.net/games/league-of-legends/)上查阅，由于不是本篇文章叙述的重点，不再多讲。

但是在游戏过程中，这样的情况出现了：我可以正常进入游戏，但是在局内的操作存在严重的延迟现象。虽然界面右上角显示的延迟在120毫秒左右，但技能和走位指令发出后往往要等1, 2秒甚至3, 4秒。经过初步猜测，这一问题的原因可能是 **环境变量配置的proxy无法代理udp包，** 甚至无法传进以wine为基础运行的游戏。

## linux的proxy 设置

linux中自带了一套[在环境变量中配置代理](https://wiki.archlinux.org/title/Proxy_server#Environment_variables)的办法。以我的配置文件为例：

![wayland中，环境变量在~/.pam_environment下配置](_media/linux/20211210-linux-env-proxy.png)

当然，现在它们已经被注释掉了。这样的代理设置方法好处是比较简便，但是也有两个缺点。

### 1. 环境变量形式的代理会需要应用检测到，才能起作用

刚接触环境变量的人或许觉得这个东西不好理解，很麻烦。不过本质上， **环境变量与其他变量并没有区别。** 在应用程序运行的时候，每时每刻都在处理各种变量。唯一不同的是，这其中大部分的变量都由程序内部定义或生成，而环境变量是外部天然存在的。例如，在程序运行时，你会需要什么输入法被唤醒？你的系统中使用A组件帮助程序运行，还是B组件？这都是程序自己没办法知道的事，需要系统来告诉它。系统变量就是其中一个方便的沟通办法。

我在linux上习惯使用firefox作为浏览器，因为chrome对环境变量的支持有些粗糙。我们来观察一下firefox的代理设置界面。

![](_media/linux/20211210-linux-firefox-proxy.png)

如果使用了环境变量，那么在这个界面中选择「使用系统代理设置」，就可以启用你的配置。同样的，若选择「不使用代理服务器」，则firefox会忽视你的环境变量，并采用直接连接的方式来处理网络请求。这一机理的背后，反应了一个事实，即 **你若采用环境变量的方式配置代理，则应用会凌驾于你的代理设置之上。** 如果这一应用不读取你的代理设置，它就不会起作用——当然在如今这种情况是很少见的。不过有些程序会特定选择大写或小写字母版本的环境变量，比如你还需要定义形如`http_proxy`的环境变量。

不管怎样，按我们的逻辑来说大家更喜欢接管应用网络流量的代理方式，这样也更符合直觉。在你对代理需求不高或者刚上手linux的情况下，设置环境变量也不失为一个好选择。在百分之九十的时候，它都会起作用。

### 2.环境变量的代理形式是应用层协议，且往往不支持socks proxy

在上图中我们看到，环境变量设置proxy的办法主要支持http, https协议（其余两个用不太多，不多介绍）。而这两者都是基于tcp的进一步封装。有些人会额外定义一个`socks5_proxy`变量，其作用大概聊胜于无。这是一个不错的想法，因为socks5除了接受tcp协议外也接受udp协议。但是如arch wiki中所写，你如果真的想用socks5代理，除了支持处理它的应用可以手动配置外，只能 **尝试** 使用tsocks或proxychains-ng等应用。我的建议是你别用了，我用过，不太好用。

至此，我们一开始的困惑解决了。大多数网络游戏的实时连接机制都是udp协议，不在乎数据包能否保障接受和发送，而更注重速度。峡谷上的操作瞬息万变，如果你和人抢龙，拼惩戒，还要什么“七次握手”，谁能受的了？同样的，我们的代理只能处理http、https协议，看到udp包时往往爱莫能助。

所以，我们理想中的代理是这样的：它能接管整个网络流量，不必在乎应用的感受；也不挑食，能把所有的tcp和udp连接一股脑转给代理。幸运的是，linux的网络配置能力很强大，市面上路由器的系统一般都是linux，包括你家里那台。而这种代理的方式也有人研究过，这就是 **透明代理** 。

## nftables的使用

透明代理中“透明”的意思，就是这一代理不会被应用感知到。一般我们会将透明代理部署到路由器或者一台与路由器连接的linux主机上，这就是你在网络上找的一些配置方式不管用的原因。本篇文章的教程中，透明代理被设置在 **本机** 上。我们使用的工具是Netfilter, 一个用于管理网络数据包的软件框架。不过由于它位于linux内核中，所以我们一般不能直接操作它，而要利用运行在用户空间的应用来与它沟通。使用比较广泛的是iptables, 不过我们不会使用它，而使用另一个工具——nftables. 其实这两者的作用大致相当，不过nftables较新，是用于取代iptables的一个新工具。

使用nftables，我们先大致了解一下这张图：

![](_media/linux/20211210-nftables-packetsflow.png)

图有点复杂，不过我们不用害怕。在本案例中，我们仅就Application Layer 和Ip Layer进行讨论，即图中黄色和绿色的部分。这张图要表示的，就是数据包在linux系统中流动的过程。如图中所示，所有要访问我们系统的ip packets会先抵达Prerouting节点，之后系统会判断它是否要进行下一步转发。如在路由器中，许多访问它的数据包的最终目的地是连接于它的电脑，这些数据就会进入Forward节点。不过我们使用的是个人主机，所以你可以先忽略它，假设所有的数据包都进入到Input节点，再传入应用层，被电脑上的应用，如firefox, clash等程序接收。而一个应用程序想要发出数据包，就先进入Output节点，再与之前Forward传出的数据包会合进入Postrouting节点，准备发出到互联网。

这一个个节点，就是我们用来操作数据包的机会。所以它们会被叫做Hook，即“钩子”，你写的对数据包的操作规则(Rules)像是一条条小鱼一样咬住特定的钩子和饵，被唤起执行。异步编程中也有关于Hook的概念，你可以使用这个形象的比喻来理解它。在一些说唱音乐中，参插在说唱歌词段(Verse)中的旋律歌词也被叫Hook, 我猜测是因为它们都很抓耳，容易钩到听众的耳朵。你听完一首陌生的说唱，可能不会对Verse记忆多深，但经常会记着或者能哼出来其中的旋律歌词部分，对不？

除了Hook概念，在nftables中你需要直到的东西还有表(Table), 链(Chain). 在nftables的配置文件中，chains被包含在tables中，而chains中则排列着一条条rules, 三者井然有序地发挥着作用。

```nftables
table ip love {
    chain my_heart {
        type nat hook output priority filter; policy accept;
        love dperson you return
        love dperson others redirect to :you
    }
}

```

我们一步一步解释。首先我们建立了一个叫做love的table, 这个table所作用的family是ip. 在nftables中有很多family, 如ip, inet, bridge, arp等。它们可以帮助选择需要被操作的数据包属于 **网络层** 中的哪种协议类型。我们最终想代理的是 **传输层** 中的tcp, udp协议连接，这对应着传输层中的ip协议。在nftables中，ip family特指ipv4连接，ipv6会被ip6 family 命中。你也可以使用inet family来同时命中这两者。我的电脑及路由设备上没有配置ipv6，所以ip类型的table就够用了。 **如果你想配置ipv6的代理，注意不能简单地改成ip6或者inet family，** 原因我们后面陆续会讲。
