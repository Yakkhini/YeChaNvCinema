# The Way to Nix

> 须知：你不应当从本文章中照抄 **任何你不理解的命令和操作!** 我的博客只是二手知识，并且缺乏时效性。本篇文章主要写于 NixOS 22.11 版本。你对你机器负有第一责任，所以应尽量按照受维护的官方文档来执行操作尤其是高危操作（如 **安装系统**）。而文章的作用是帮助你了解和熟悉那些东西。

今年春天的时候知道了 Nix 和 Nix OS，立刻就产生了很大兴趣。我比较喜欢它原子化系统和函数式生成的哲学。

用了很久的 Linux 桌面，也算是了解了其中的一些好处和坏处。最令我不满意的是 Linux 系统中始终有一些文件游离于我的控制之外。大部分的 Linux 发行版都有包管理器，让它的文件安装系统比 Windows 东装一块、西装一块的繁杂错乱好上不少。但是我的 `~/.config` 文件夹现在简直就像一场灾难。已装的和被卸载的软件，那些配置文件和配置文件夹堆在一起，令人很不满意。

除此之外，在使用了很久 Linux 系统后，我发现了一个令人难过的事情：我可能根本不知道我的电脑上目前装了多少个软件，每个软件是干什么用的、哪个软件其实是没什么必要、可以卸载的。

是的，虽然我有包管理器，可以使用 `yay -Qs` 命令来输出我本地所有的已装软件，但分辨它们每一个仍是一件不容易的事。我的电脑上可能已经装了数百个软件包，但我没有时间去把它们每一个都梳理清楚。Linux 碎片化的软件生态带给了我们简洁、方便和轻巧的系统使用体验，但这种碎片化在一定程度上也为我们管理自己的系统带来了一些困难。

在我看来，Linux 的发展历史就是一个在统合和碎片中找平衡的历史，努力在这二元中寻找并存的历史。系统中有文件系统、硬件系统、进程管理系等模块（碎片），于是 Linux 设计了“一切皆文件”的设计哲学来统合；个人开发者难以承担大型开源项目的开发（碎片），于是我们逐渐开始使用 Git 等工具、开源社区的建立来对齐碎片开发者的协作；各个软件包之间需要配合才能协同使用（碎片），于是我们在包管理器中引入依赖分析等特性来处理这些事务。

可以说，这就是我喜欢开源世界的原因之一——它努力地避免中心化与集权的同时，也注重每一个独立个体之间的合作，统合出有效、理智、可用的方案来。我认为在未来的世界中这一种思想会走得更远。

而现在，在 Nix 中这一路线延续下去了。它尊重软件的碎片化，并努力统合这些碎片提供给我们。

决定尝试 Nix 的契机有二。首先来讲，Nix 和 Nix OS 是两个有关系但性质不同的事物。后者代表一个发行版，前者只是一个包管理器。Nix 包管理器的安装并没有什么前置条件，也就是说你大可以直接逐步用它代替你目前使用系统的发行版官方包管理器。实际上，**渐进式** 的思想在整个 Nix 世界中贯穿到底。你可以不必费很大力气，比如重装你现在的系统就能感受到它。而当你决定使用 Nix OS 时，它 **NIXOS_LUSTRATE** 的安装特性甚至可以让你直接在本系统中进行安装和替换工作。

> *「Because Nix (the package manager) & Nixpkgs (the Nix packages collection) can both be installed on any (most?) Linux distributions, they can be used to install NixOS in various creative ways. You can, for instance:*
> 
> [...]
> 
> *「2.Install NixOS on the same partition (in place!), from your existing non-NixOS Linux distribution using **NIXOS_LUSTRATE**.」*
> 
> —— NixOS - NixOS 22.05 manual

我很喜欢这种渐进式的哲学。想尝鲜 Nix 的另一个原因是，不久前它终于进入了 Arch 的 Community 软件库（详见 [Arch Linux - nix](https://archlinux.org/packages/community/x86_64/nix/)）。这代表着 Nix 包的打包质量有了保证。

## Nix package manager

对于是否要用 Pacman 安装 Nix，我个人还是有些纠结的。对于一般的软件，保持包管理器对其的追踪是一个良好并且应当坚持的习惯；但是一个包管理器是否有资格去安装另一个包管理器呢？毕竟，当你在使用 PKGBUILD 的时候，就相当于或多或少地改变了官方的安装脚本设计。对一般软件来说，这样做无伤大雅，甚至更好，因为 Pacman 会对这些修改的部分负责，这种合理的掌控也更利于软件包与 Arch 协同。但是在我们的期待中，Nix 对 Pacman 并不是从属而是替代的关系。这暗含了一件事情：当 Nix 逐步替代 Pacman 到最后，Pacman 唯一做的事就是为安装 Nix 的 PKGBUILD 负责。而当我们的系统真正失去了 Pacman 时，由 PKGBUILD 安装的 Nix 就失去了它的负责者。

> *「There are two choices for a Nix installation, **one is supported by Arch Linux,** and **the other is officially supported by Nix.」***
> 
> —— Nix - ArchWiki

诚然，我相信 Community 软件库的打包质量，Nix 最终安装到我系统里的实际体验是完好的、甚至与脚本安装到我系统目录中的高权限文件没有区别。但这是一个程序正义的问题。另一方面，我们知道 Nix 与 Nix OS 在最终的模样摆脱了 FHS 文件目录组织规范，这与 Arch 的打包规范是否有冲突？这些是在合理推测中，将来可能会出现的雷点。

不过这目前并不是什么大不了的问题。我目前可以暂时使用 Nix 部分替代 Pacman，在最后想要安装 Nix OS 时再从官方脚本中重新安装就好。那么我担心的问题就变成了在那个时候官方的 Nix 能否接管我原先 Nix 的工作，继续追踪之前安装的软件包了。这一点我想是比较容易被解决的，因为 Nix 作为函数式包管理器，摧毁与复现是它的强项。可能我到时候只需要改动一下配置声明文件就好了。或者，我在学习使用 Nix 以及 Linux 包管理系统的过程中就能找到解决这个问题的办法，甚至最终发现我根本是在担心一些不存在的问题。

所以说，我目前打算从 Official repositories 中安装 Nix，剩下的从长计议。

> *注：在后续的安装 NixOS 过程中发现，从 Arch repositories 中安装的 Nix 会产生各种奇怪的问题。按照 Nix Community 的建议，还是按照官方途径，curl 安装脚本来安装会比较好。*

```bash
> yay -S nix
```
在安装 Nix 后，使用前首先要将用户添加到 nix-users 用户组中，并启动 Nix 的 daemon 服务。

```bash
> gpasswd -a username nix-users
> systemctl enable nix-daemon.service
> systemctl start nix-daemon.service
```

接着就可以按照 Arch Wiki 中的步骤，在更新官方源后安装一个 hello 软件包。

```bash
> nix-channel --add https://nixos.org/channels/nixpkgs-unstable
> nix-channel --update
> nix-env -iA nixpkgs.hello

> hello
```

**OUTPUT:**

```
Hello, world!
```

## NixOS Installment

如何安装 NixOS 在 [NixOS Manual](https://nixos.org/manual/nixos/stable/) 中有详细说明。本文比较具有特色的一点是，我打算体验 NixOS 的 **LUSTRATE** 功能。我的机器是在以下几个条件中进行的：

* 本机在安装前使用 Manjaro 系统，安装后为 NixOS 22.11 系统；
* 本机中除了 Linux，还有一个 Windows 10 系统，和 Manjaro 一起使用 Grub 引导；
* 本机安装 NixOS 没有对分区或者 Manjaro 做任何格式化和数据清除，直接在原系统运行中使用 **LUSTRATE** 将其替换成 NixOS。

> *「lustrate /ˈlʌstreɪt/ verb.」*
>
> *「purify by expiatory sacrifice, ceremonial washing, or some other ritual action.」*
>
> —— NixOS - NixOS 22.11 manual

### 完美地从 Arch 系发行版中卸载 Nix 包管理器，并从官方源单用户重装

在尝试过 Nix 包管理器后，想要转移到 NixOS这一发行版的想法由然而生。使用 **LUSTRATE** 安装的步骤在 [NixOS Manual 2.4.5. Installing from another Linux distribution](https://nixos.org/manual/nixos/stable/index.html#sec-installing-from-other-distro) 一节中可以找到。注意步骤 4 到 8 对于 **LUSTRATE** 可以忽略（详见 Note）。

但是问题在于，我的机器在按照步骤安装时总会产生一些不被期望的结果。我猜测这是因为我的 Manjaro 已经很久没有更新，导致 nix 版本老旧，与 NixOS 22.11 不匹配的结果。同时，使用 pacman 安装的 nix 包是多用户安装，与手册中的单用户安装不符。

总之，我想之前关于是否要使用 Pacman 安装 nix 的担心成为了现实。最好的办法，就是完全删除之前的 nix，并从 nix 官方源安装，以保证我安装 NixOS 的系统状态尽量与 Manual 一致。

完全删除 nix 可以在 [Nix Manual - Installing a Binary Distribution#uninstalling](https://nixos.org/manual/nix/stable/installation/installing-binary.html#uninstalling) 中找到。需要注意的是，仅使用 Pacman 删除 nix 是不够的，还有 nix 遗留相关路径、用户和用户组等需要处理。

```bash
# 首先要从 pacman 本地软件库中卸载 nix
> yay -R nix

# 删除与 nix 有关的所有路径
> sudo rm -rf /nix /etc/nix /etc/profile/nix.sh ~root/.nix-profile ~root/.nix-defexpr ~root/.nix-channels ~/.nix-profile ~/.nix-defexpr ~/.nix-channels

# 删除与 nix 有关的用户等。你需要注意的是，通过 Pacman 创建的
# 相关用户及用户组名称和 id 可能与下方 Nix Manual 中所示不同，
# 需要手动查看本机的用户及用户组后删除相关内容。
> for i in $(seq 30001 30032); do\
  sudo userdel $i\
done\
sudo groupdel 30000

# 停止相关服务
> sudo systemctl stop nix-daemon.socket
> sudo systemctl stop nix-daemon.service
> sudo systemctl disable nix-daemon.socket
> sudo systemctl disable nix-daemon.service
> sudo systemctl daemon-reload

```

接着，根据 NixOS Manual 2.4.5. 进行 nix 单用户安装：

```bash
> curl -L https://nixos.org/nix/install | sh
```

然后遵循其步骤继续修改 channel，安装工具包。注意，此处 channel 更改与 nix 常规安装有所不同，以 NixOS Manual 为准。

### 初探 configuration.nix

生成 `configuration.nix` 文件。

```bash
sudo `which nixos-generate-config`
```

生成的两个文件会存放在 /etc/nixos 路径中。`hardware-configuration.nix` 用于声明新系统的硬件和驱动等，由工具包自动检测你的硬件状态生成。不用修改它，除非你知道自己在做什么。在接下来的旅程中，`configuration.nix` 会陪伴我们很久。如果你不打算使用 **Flake** 来声明你的系统，那么这个文件会陪伴你使用 NixOS 的每一天。

使用 vim 打开它，进行一些配置吧。

#### 双引导系统如何配置 Grub

首先你应该看到的是 `boot.loader` 选项。由于我的机器内还有一个 Windows 10 双系统，在之前就采用 GRUB 2 来进行引导，所以不能使用 systemd-boot 来引导启动了。关于这一部分如何配置，你可以看 NisOS Manual 2.3.3 第 4 步骤详解。除此之外，你也可以看附录的 Options 中关于 [boot.loader.grub](https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.grub.enable) 和 [boot.loader.systemd-boot](https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.systemd-boot.enable) 内容详解。在开始使用 `configuration.nix` 后，我们会慢慢开始学着查阅这个附录。如果你想要进一步关于 GRUB 和 systemd-boot 的知识，可以去查阅它们的 Arch wiki：[GRUB](https://wiki.archlinux.org/title/GRUB)，[systemd-boot](https://wiki.archlinux.org/title/Systemd-boot)。如果你想看一看有关双系统引导的其他博客，我在知乎上找到了 [NixOS 与 Windows 双系统启动安装教程 - 知狐](https://zhuanlan.zhihu.com/p/441190715)。需要注意的是，知狐的配置比较复杂，而你不必像他一样复杂，因为我们作为初学者最重要的是让 NixOS 顺利跑起来即可，也就是 **尽可能只做必要的事。**

我来展示以下我的 `boot.loader` 配置片段。

```nix
...
# Use the GRUB boot loader.
  boot.loader = {
    efi.canTouchEfiVariables = true;
    efi.efiSysMountPoint = "/boot/efi";

    grub = {
      enable = true;
      device = "nodev";
      efiSupport = true;
      useOSProber = true;
    };
  };
...
```

我想你在阅读以上信息后，也能写出适合你机器的、比较精简的配置。在这一配置中我 efi 挂载点是 `/boot/efi` 而不是默认的 `/boot`。为什么会这样？其实我一开始也将其设定为 `/boot` 但是无法跑通。通过 `/etc/fstab` 看到我的挂载设置后我知道了原因：

```fs
...
# /dev/nvme0n1p1 LABEL=ESP
UUID=FAFF-EE0B      	/boot/efi 	vfat      	rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=iso8859-1,shortname=mixed,utf8,errors=remount-ro	0 0
...
```

我的 efi 硬盘分区被挂载到了 `/boot/efi` 上。

#### 尽可能精简配置

新人安装 NixOS 的一个误区在于：他们想在安装 NixOS 之前就把配置文件写得很复杂，想要自己的桌面在安装后第一次启动就有精彩的效果。但实际上这是他们安装失败，或者系统无法启动的根源之一。**我们知道，一个系统的信息熵越大，这个系统就越难管理。所以，请尽量精简你的配置。**你只需要在默认生成的模板中去掉一些注释，就可以进入 NixOS 的 console。第一次成功启动后再慢慢管理系统的演进是一个不错的策略。

我的第一次安装，去掉了 networkmanager 的注释，设置 timeZone 为 `"Asia/Shanghai"`，去掉了 `xserver.enable` 的注释和 `sound.enable`，及 pulseaudio 的注释，简单地设置了 user，关闭了防火墙 `networking.firewall.enable = false`。简单配置了 i18n 的字体，在 `sysemPackages` 去掉了 vim 的注释，并额外安装了 ranger。

这已经足够。至于图形界面、输入法、窗口管理器等我完全可以在安装成功进入系统后再进一步配置。

### 安装 NixOS

按手册指导把剩下的工作做完后，我还做了一些备份工作（如导出 GPG 密钥），放在了我的 `$HOME` 文件夹里。然后应该做的事是把 `$HOME` 也加入 `/etc/NIXOS_LUSTRATE` 文件里。我没有执行这一步骤,不过 NixOS 仍然没有将原 `/home` 放入 `/old-root`。其实它也无法放入，因为我 `/home` 在硬盘中单独有一个分区且占用了巨大的存储空间，以至于无法挪到 `/old-root` 中。其实这是一个有风险的操作，还是在 LUSTRARE 文件里声明它比较好。

卸载了一些软件，以给新系统腾出来很多空间。接着就开始安装系统了。

```bash
> sudo mv -v /boot /boot.bak &&
sudo /nix/var/nix/profiles/system/bin/switch-to-configuration boot
```

安装比较常见的问题就是网络不佳，以至于无法下载相关的软件包。解决的办法可以是按照手册中所述挂代理来安装，也可以将 channel 换为清华源 [nix | 镜像站使用帮助 | 清华大学开源软件镜像站 | Tsinghua Open Source Mirror](https://mirrors.tuna.tsinghua.edu.cn/help/nix/)。你需要注意的是我们之前在手册中配置的 channel 有些特殊，将 nixpkgs 对应为了 nixos 仓库。请不要直接使用清华源使用帮助的命令。

综上所述，我想我们知道了你应当尽量精简你的系统配置的更多原因：

* 在初次安装时你的存储空间里有两个系统并存，所以可能余量有限。如果在配置中写入很多东西，会因为下载空间不足而失败；
* 如果你的网络不太好，声明越复杂代表着要从远程仓库里下载更多东西，安装过程会因为不健康的网络而被拖长，这是不必要的。

至此，在重新启动后我获得了一份崭新的 NixOS 系统，Nix 之旅也将在这里继续。

```bash
> neofetch
          ▗▄▄▄       ▗▄▄▄▄    ▄▄▄▖            yakkhini@nixos
          ▜███▙       ▜███▙  ▟███▛            --------------
           ▜███▙       ▜███▙▟███▛             OS: NixOS 22.11.20230101.0bf3109 (Raccoon) x86_64
            ▜███▙       ▜██████▛              Host: Dell Inc. 0J8RVN
     ▟█████████████████▙ ▜████▛     ▟▙        Kernel: 5.15.85
    ▟███████████████████▙ ▜███▙    ▟██▙       Uptime: 3 hours, 50 mins
           ▄▄▄▄▖           ▜███▙  ▟███▛       Packages: 743 (nix-system), 4767 (nix-user)
          ▟███▛             ▜██▛ ▟███▛        Shell: zsh 5.9
         ▟███▛               ▜▛ ▟███▛         CPU: Intel i5-8265U (8) @ 3.900GH
▟███████████▛                  ▟██████████▙   GPU: NVIDIA GeForce MX250
▜██████████▛                  ▟███████████▛   GPU: Intel WhiskeyLake-U GT2 [UHD Graphics 620]
      ▟███▛ ▟▙               ▟███▛            Memory: 3613MiB / 7672MiB
     ▟███▛ ▟██▙             ▟███▛             
    ▟███▛  ▜███▙           ▝▀▀▀▀              
    ▜██▛    ▜███▙ ▜██████████████████▛        
     ▜▛     ▟████▙ ▜████████████████▛         
           ▟██████▙       ▜███▙               
          ▟███▛▜███▙       ▜███▙
         ▟███▛  ▜███▙       ▜███▙
         ▝▀▀▀    ▀▀▀▀▘       ▀▀▀▘
```


## 初入 NixOS 配置

### 为什么要声明式地描述系统的样子

### 原生 Options

### Home Manager 是什么，可以做什么

### 配置

#### Git，GnuPG 配置

#### 字体，fcitx5

#### fontconfig

#### vscode

#### greetd 和 tuigreet

#### 第一次 Override——鼠标和主题，以及我们的下一步

## Nix Ecosystem 进阶

## 参考

[*Nix Manual*](https://nixos.org/manual/nix/stable/)

[*NixOS Manual*](https://nixos.org/manual/nixos/stable/)

[*Nix - ArchWiki*](https://wiki.archlinux.org/title/Nix)
